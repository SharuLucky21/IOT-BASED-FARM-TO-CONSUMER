<!DOCTYPE html>
<html>
<head>
<title>Live Tracking | Smart Eco Farm</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body {
  margin: 0;
  font-family: "Segoe UI", Arial;
  background: #f4f6f8;
}

.header {
  background: white;
  padding: 15px 40px;
  font-size: 22px;
  font-weight: bold;
  color: #27ae60;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.container {
  display: flex;
  gap: 30px;
  padding: 30px;
}

#map {
  width: 55%;
  height: 600px;
  border-radius: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  z-index: 1;
}

.info {
  width: 45%;
  background: white;
  padding: 30px;
  border-radius: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.info h2 {
  margin-bottom: 20px;
}

.metric {
  font-size: 18px;
  margin: 15px 0;
}
</style>
</head>

<body>

<div class="header">ğŸŒ± Smart Eco Farm â€“ Live Delivery Tracking</div>

<div class="container">
  <div id="map"></div>

  <div class="info">
    <h2>Live Conditions</h2>
    <div class="metric">ğŸŒ¡ Temperature: <b><span id="temp">--</span> Â°C</b></div>
    <div class="metric">ğŸ’§ Humidity: <b><span id="hum">--</span> %</b></div>
    <div class="metric">ğŸƒ Freshness: <b><span id="fresh">--</span> %</b></div>
    <div class="metric">ğŸ“ Distance Covered: <b><span id="distance">0.00</span> km</b></div>
    
    <hr style="margin:30px 0; border:0; border-top:1px solid #eee;">
    
    <h3>Order Status</h3>
    <div style="margin-top:20px; display:flex; flex-direction:column; gap:20px;">
        <div style="display:flex; align-items:center; gap:15px;">
            <div id="status-ordered" style="width:40px; height:40px; background:#27ae60; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <img src="https://cdn-icons-png.flaticon.com/512/2972/2972185.png" style="width:25px; filter:invert(1);">
            </div>
            <span><b>Ordered</b></span>
        </div>
        <div style="width:2px; height:20px; background:#ddd; margin-left:19px;"></div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div id="status-delivery" style="width:40px; height:40px; background:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <img src="https://cdn-icons-png.flaticon.com/512/709/709790.png" style="width:25px;">
            </div>
            <span style="color:#888;">Out for Delivery</span>
        </div>
        <div style="width:2px; height:20px; background:#ddd; margin-left:19px;"></div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div id="status-delivered" style="width:40px; height:40px; background:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <img src="https://cdn-icons-png.flaticon.com/512/1161/1161388.png" style="width:25px;">
            </div>
            <span style="color:#888;">Delivered</span>
        </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map, marker, pathLayer;
let pathCoordinates = [];
let totalDistance = 0;

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Radius of the earth in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function calculateFreshness(temp, hum) {
  let freshness = 100;
  freshness -= Math.abs(temp - 25) * 2;
  freshness -= Math.abs(hum - 65);
  return Math.max(0, Math.min(100, Math.round(freshness)));
}

function initMap(lat = 17.3850, lon = 78.4867) {
  map = L.map('map').setView([lat, lon], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  marker = L.marker([lat, lon]).addTo(map)
    .bindPopup('Delivery Vehicle')
    .openPopup();

  // Thicker path with dash array for better road visibility
  pathLayer = L.polyline([], { 
    color: '#e67e22', 
    weight: 8, 
    opacity: 0.7,
    dashArray: '1, 10' 
  }).addTo(map);
}

function updateTracking() {
  const urlParams = new URLSearchParams(window.location.search);
  const deviceId = urlParams.get('deviceId') || "DEV123";

  // Update status
  fetch(`/api/order_status/${deviceId}`)
    .then(res => res.json())
    .then(data => {
      const status = data.status;
      
      // Reset all
      document.getElementById("status-ordered").style.background = "#ddd";
      document.getElementById("status-ordered").querySelector("img").style.filter = "none";
      document.getElementById("status-delivery").style.background = "#ddd";
      document.getElementById("status-delivery").querySelector("img").style.filter = "none";
      document.getElementById("status-delivered").style.background = "#ddd";
      document.getElementById("status-delivered").querySelector("img").style.filter = "none";
      
      if (status === "Ordered") {
        document.getElementById("status-ordered").style.background = "#27ae60";
        document.getElementById("status-ordered").querySelector("img").style.filter = "invert(1)";
      } else if (status === "Out for Delivery") {
        document.getElementById("status-ordered").style.background = "#27ae60";
        document.getElementById("status-ordered").querySelector("img").style.filter = "invert(1)";
        document.getElementById("status-delivery").style.background = "#27ae60";
        document.getElementById("status-delivery").querySelector("img").style.filter = "invert(1)";
      } else if (status === "Delivered") {
        document.getElementById("status-ordered").style.background = "#27ae60";
        document.getElementById("status-ordered").querySelector("img").style.filter = "invert(1)";
        document.getElementById("status-delivery").style.background = "#27ae60";
        document.getElementById("status-delivery").querySelector("img").style.filter = "invert(1)";
        document.getElementById("status-delivered").style.background = "#27ae60";
        document.getElementById("status-delivered").querySelector("img").style.filter = "invert(1)";
      }
    });

  // Fetch full history to rebuild the path
  fetch(`/api/history/${deviceId}`)
    .then(res => res.json())
    .then(historyData => {
      if (!historyData || Object.keys(historyData).length === 0) {
        // Fallback to latest if no history
        fetch(`/api/track/${deviceId}`)
          .then(res => res.json())
          .then(data => {
            if (data.latitude) {
              const lat = data.latitude;
              const lon = data.longitude;
              marker.setLatLng([lat, lon]);
              updateMetrics(data);
            }
          });
        return;
      }

      const coords = Object.values(historyData).map(h => [h.latitude, h.longitude]);
      pathCoordinates = coords;
      pathLayer.setLatLngs(pathCoordinates);
      
      // Calculate total distance from history
      let dist = 0;
      for(let i=1; i<coords.length; i++) {
        dist += calculateDistance(coords[i-1][0], coords[i-1][1], coords[i][0], coords[i][1]);
      }
      totalDistance = dist;
      document.getElementById("distance").innerText = totalDistance.toFixed(2);

      // Latest position
      const latest = coords[coords.length - 1];
      marker.setLatLng(latest);
      
      // Update metrics with latest record
      const latestRecord = Object.values(historyData).pop();
      updateMetrics(latestRecord);
    });
}

function updateMetrics(data) {
  document.getElementById("temp").innerText = data.temperature;
  document.getElementById("hum").innerText = data.humidity;
  document.getElementById("fresh").innerText =
    calculateFreshness(data.temperature, data.humidity) + "%";
}

// Initial load
const urlParams = new URLSearchParams(window.location.search);
const currentDeviceId = urlParams.get('deviceId') || "DEV123";

fetch(`/api/track/${currentDeviceId}`)
  .then(res => res.json())
  .then(data => {
    initMap(data.latitude || 17.4401, data.longitude || 78.3489);
    updateTracking();
  });

// ğŸ” Update every 10 seconds
setInterval(updateTracking, 10000);
</script>

</body>
</html>
